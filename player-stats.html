<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hive æˆç¸¾ã‚’è¦‹ã‚‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f8fafc; }
  .hero-small { background:#222; padding:2.5rem 1rem; color:#fff; text-align:center; }
  .stat-card { transition: .15s; }
  .stat-card:hover { transform: translateY(-4px); }
  #loading { display:none; }
  .small-muted { font-size:0.9rem; color:#666; }
  pre { white-space:pre-wrap; word-break:break-word; }
</style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="index.html">Minecraft PVP & HIVE</a>
  </div>
</nav>

<header class="hero-small">
  <h1 class="fw-bold">Hive æˆç¸¾ã‚’æ¤œç´¢</h1>
  <p class="small-muted">ã‚²ãƒ¼ãƒãƒ¼ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦ Enter ã¾ãŸã¯ãƒœã‚¿ãƒ³ã§æ¤œç´¢</p>
</header>

<section class="py-4">
  <div class="container" style="max-width:720px;">
    <div class="input-group mb-2">
      <input id="gamertag" class="form-control" placeholder="ä¾‹: ItsK1sshy">
      <button id="btnSearch" class="btn btn-warning">â–¶ æ¤œç´¢</button>
    </div>
    <div id="loading" class="mb-2">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div id="result"></div>
    <div id="debug" class="mt-3 small text-muted"></div>
  </div>
</section>

<script>
const proxies = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  url => `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(url)}`
];

// ä¸»è¦ APIï¼ˆã¾ãš playhive ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã—ã¾ã™ï¼‰
function buildApiUrl(username) {
  // éå»ã®ã‚³ãƒ¼ãƒ‰ã§ä½¿ã£ã¦ã„ãŸ playhive ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæœ€ã‚‚æƒ…å ±é‡å¤šã‚
  return `https://api.playhive.com/v0/game/all/${encodeURIComponent(username)}`;
}

document.getElementById('btnSearch').addEventListener('click', searchPlayer);
document.getElementById('gamertag').addEventListener('keyup', (e) => {
  if (e.key === 'Enter') searchPlayer();
});

async function searchPlayer() {
  const name = document.getElementById('gamertag').value.trim();
  const resultEl = document.getElementById('result');
  const debugEl = document.getElementById('debug');
  if (!name) { alert('ã‚²ãƒ¼ãƒãƒ¼ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  resultEl.innerHTML = '';
  debugEl.textContent = '';
  document.getElementById('loading').style.display = 'block';

  const apiUrl = buildApiUrl(name);
  let lastError = null;
  let usedProxy = null;
  let json = null;
  let rawText = null;

  // try proxies in sequence
  for (let i=0;i<proxies.length;i++) {
    const p = proxies[i];
    const fetchUrl = p(apiUrl);
    try {
      console.info('è©¦è¡Œä¸­ã®URL:', fetchUrl);
      const res = await fetch(fetchUrl, { cache: 'no-store' });
      if (!res.ok) {
        lastError = `HTTP ${res.status} ${res.statusText} from proxy #${i+1}`;
        console.warn(lastError);
        continue; // æ¬¡ã®proxyã¸
      }
      rawText = await res.text();

      // try parse JSON
      try {
        json = JSON.parse(rawText);
      } catch(parseErr) {
        lastError = `ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆproxy #${i+1}ï¼‰ã€‚æœ€åˆã®100æ–‡å­—: ` + rawText.slice(0,100);
        console.warn(lastError);
        // JSONã§ãªã„ãªã‚‰æ¬¡ã®proxyã‚’è©¦ã™ï¼ˆæ™‚ã€…HTMLã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’è¿”ã™ï¼‰
        continue;
      }

      // got JSON
      usedProxy = `proxy #${i+1}`;
      break;
    } catch (err) {
      lastError = `ãƒ•ã‚§ãƒƒãƒå¤±æ•—(proxy #${i+1}): ${err.message}`;
      console.warn(lastError, err);
      // æ¬¡ã®proxyã¸
    }
  }

  document.getElementById('loading').style.display = 'none';

  if (!json) {
    // ã™ã¹ã¦ã®proxyã§å¤±æ•—
    resultEl.innerHTML = `
      <div class="alert alert-danger">
        <strong>å–å¾—ã‚¨ãƒ©ãƒ¼</strong> â€” ã™ã¹ã¦ã®ä¸­ç¶™ã‚’è©¦ã—ã¾ã—ãŸãŒãƒ‡ãƒ¼ã‚¿å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
        <small>åŸå› ã¨ã—ã¦ã¯ï¼šAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¤‰æ›´ã€ãƒ—ãƒ­ã‚­ã‚·ã®ä¸€æ™‚åœæ­¢ã€CORSåˆ¶é™ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ ãªã©ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚</small>
      </div>
      <details class="mt-2"><summary>æŠ€è¡“æƒ…å ±ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰</summary>
        <pre>${escapeHtml(lastError || rawText || 'è©³ç´°æƒ…å ±ãªã—')}</pre>
      </details>
    `;
    debugEl.innerHTML = `æœ€å¾Œã«è©¦ã—ãŸæƒ…å ±ï¼ˆconsoleã«ã‚‚å‡ºåŠ›ï¼‰`;
    console.error('å–å¾—å¤±æ•—ã®æœ€çµ‚æƒ…å ±:', lastError);
    return;
  }

  console.info('å–å¾—æˆåŠŸ via', usedProxy, json);
  renderStats(json, name, usedProxy);
}

function renderStats(data, name, via) {
  const container = document.getElementById('result');

  // playhiveãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æƒ³å®šã«åˆã‚ã›ã¦å®‰å…¨ã«èª­ã¿å‡ºã™
  // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒé•ã†å ´åˆã¯ raw ã‚’è¡¨ç¤º
  function safe(v){ return (v===undefined||v===null) ? 0 : v; }

  // If response indicates no stats
  if (Object.keys(data).length === 0 || data.error || data.message) {
    container.innerHTML = `<div class="alert alert-warning">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${escapeHtml(name)} ã®æˆ¦ç¸¾ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ï¼ˆAPIå¿œç­”: ${escapeHtml(JSON.stringify(data).slice(0,200))}ï¼‰</div>`;
    return;
  }

  // ç·åˆæƒ…å ±
  let html = `<h4 class="mb-3">ğŸ‘‘ ${escapeHtml(name)} ã®æˆç¸¾ï¼ˆå–å¾—çµŒè·¯: ${escapeHtml(via)})</h4>`;

  // ä¸€èˆ¬æƒ…å ±ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
  if (data.UUID || data.username || data.player) {
    html += `<div class="card mb-3"><div class="card-body">`;
    html += `<p class="mb-1"><strong>UUID:</strong> ${escapeHtml(data.UUID || data.uuid || '')}</p>`;
    html += `<p class="mb-1"><strong>è¡¨ç¤ºå:</strong> ${escapeHtml(data.username || data.player || name)}</p>`;
    html += `</div></div>`;
  }

  // ã‚²ãƒ¼ãƒ åˆ¥ï¼ˆplayhiveã® 'TreasureWars','SkyWars' ãªã©ã‚’æœŸå¾…ï¼‰
  if (data.TreasureWars || data.SkyWars || data.Games || data.games || data.games_stats) {
    html += `<h5 class="mt-3">ğŸ® ãƒ¢ãƒ¼ãƒ‰åˆ¥</h5>`;
    // try multiple possible keys
    const gamesObj = data.games || data.Games || data.games_stats || data;
    Object.keys(gamesObj).forEach(g => {
      const game = gamesObj[g] || {};
      // skip non-object
      if (typeof game !== 'object') return;
      const wins = safe(game.wins || game.victories || game.Wins);
      const kills = safe(game.kills || game.Kills);
      const deaths = safe(game.deaths || game.Deaths);
      const kd = (kills && deaths) ? (kills / (deaths||1)).toFixed(2) : '-';
      html += `
        <div class="card stat-card mb-2">
          <div class="card-body">
            <h6 class="card-title mb-2">${escapeHtml(g)}</h6>
            <p class="mb-0"><strong>Wins:</strong> ${escapeHtml(wins)}</p>
            <p class="mb-0"><strong>Kills:</strong> ${escapeHtml(kills)}</p>
            <p class="mb-0"><strong>Deaths:</strong> ${escapeHtml(deaths)}</p>
            <p class="mb-0"><strong>K/D:</strong> ${escapeHtml(kd)}</p>
          </div>
        </div>
      `;
    });
  } else {
    // æƒ³å®šå¤–ã®æ§‹é€ ãªã‚‰ raw ã‚’å‡ºã™
    html += `<div class="alert alert-info">å–å¾—ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ãŒæƒ³å®šã¨ç•°ãªã‚Šã¾ã™ã€‚ä¸‹ã«ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>`;
    html += `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
  }

  container.innerHTML = html;
}

function escapeHtml(str) {
  if (typeof str !== 'string') str = String(str);
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
